# =============================================================================
# EventHub Pipeline Configuration
# =============================================================================
# This file configures the EventHub-based event processing pipeline.
# Supports ${VAR} and ${VAR:-default} syntax for environment variable expansion.
# Secrets use env var references so they are never stored in this file.
#
# NOTE: Kafka has been removed - EventHub is used for all pipeline communication
#
# Priority chain (highest wins):
#   1. OS environment variables (Jenkins envVars in deployed environments)
#   2. .env file (local development — only sets vars not already in OS)
#   3. Values in this YAML (with ${VAR:-default} expansion)
#   4. Dataclass defaults in Python config classes
# =============================================================================

# =============================================================================
# ENVIRONMENT & PLATFORM
# =============================================================================
# =============================================================================
# PIPELINE CONFIGURATION
# =============================================================================
pipeline:
  # ---------------------------------------------------------------------------
  # Verisk Domain
  # ---------------------------------------------------------------------------
  verisk:
    retry_delays: [300, 600, 1200, 2400]  # 5m, 10m, 20m, 40m

  # ---------------------------------------------------------------------------
  # ClaimX Domain
  # ---------------------------------------------------------------------------
  claimx:
    retry_delays: [300, 600, 1200, 2400]  # 5m, 10m, 20m, 40m

  # ---------------------------------------------------------------------------
  # Shared Storage
  # ---------------------------------------------------------------------------
  storage:
    onelake_base_path: ${ONELAKE_BASE_PATH:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Files/<app-name>}
    onelake_domain_paths:
      verisk: "abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Files/<app-name>/verisk/attachments"
      claimx: "abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Files/<app-name>/claimx/attachments"
    cache_dir: ${CACHE_DIR:-/mnt/<app-name>/cache}
    temp_dir: ${TEMP_DIR:-/mnt/<app-name>/tmp}
    retry_persistence_dir: ${RETRY_PERSISTENCE_DIR:-/mnt/<app-name>/retry}

# =============================================================================
# AZURE AUTHENTICATION
# =============================================================================
# Secrets use env var references — never stored as plain text in this file.
# In deployed environments, Jenkins injects these as OS env vars.
# Locally, set them in the .env file.
azure:
  tenant_id: ${AZURE_TENANT_ID}
  client_id: ${AZURE_CLIENT_ID}
  client_secret: ${AZURE_CLIENT_SECRET}
  workspace_id: ${AZURE_WORKSPACE_ID:-<workspace-id>}
  lakehouse_id: ${AZURE_LAKEHOUSE_ID:-<lakehouse-id>}

# =============================================================================
# DELTA LAKE TABLE PATHS
# =============================================================================
delta:
  enable_writes: true

  # XACT domain
  verisk:
    events_table_path: ${XACT_DELTA_EVENTS_TABLE:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Tables/dbo/verisk_events}
    inventory_table_path: ${XACT_DELTA_INVENTORY_TABLE:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Tables/dbo/verisk_attachments}
    failed_table_path: ""

  # ClaimX domain
  claimx:
    events_table_path: ${CLAIMX_DELTA_EVENTS_TABLE:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Tables/dbo/claimx_events}
    inventory_table_path: ${CLAIMX_DELTA_INVENTORY_TABLE:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Tables/dbo/claimx_attachments}
    failed_table_path: ""
    projects_table_path: ${CLAIMX_DELTA_PROJECTS_TABLE:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Tables/dbo/claimx_projects}
    contacts_table_path: ${CLAIMX_DELTA_CONTACTS_TABLE:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Tables/dbo/claimx_contacts}
    media_table_path: ${CLAIMX_DELTA_MEDIA_TABLE:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Tables/dbo/claimx_attachment_metadata}
    tasks_table_path: ${CLAIMX_DELTA_TASKS_TABLE:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Tables/dbo/claimx_tasks}
    task_templates_table_path: ${CLAIMX_DELTA_TASK_TEMPLATES_TABLE:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Tables/dbo/claimx_task_templates}
    external_links_table_path: ${CLAIMX_DELTA_EXTERNAL_LINKS_TABLE:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Tables/dbo/claimx_external_links}
    video_collab_table_path: ${CLAIMX_DELTA_VIDEO_COLLAB_TABLE:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Tables/dbo/claimx_video_collab}

# =============================================================================
# CLAIMX API
# =============================================================================
claimx:
  api:
    base_url: ${CLAIMX_API_BASE_PATH:-https://your-claimx-api-host/service/cxedirest}
    timeout_seconds: 30
    max_concurrent: 20
    # Token loaded from CLAIMX_API_TOKEN env var

# =============================================================================
# PLUGINS - ITEL CABINET API
# =============================================================================
itel_cabinet:
  api_base_url: ${ITEL_CABINET_API_BASE_URL}
  api_token: ${ITEL_CABINET_API_TOKEN}
  delta_forms_table: ${ITEL_DELTA_FORMS_TABLE}
  delta_attachments_table: ${ITEL_DELTA_ATTACHMENTS_TABLE}
  attachments_path: ${ITEL_ATTACHMENTS_PATH}

# =============================================================================
# TRANSPORT LAYER CONFIGURATION
# =============================================================================
# Select transport protocol: "eventhub" (default) or "kafka"
# Event Hub is required for Azure Private Link (AMQP port 443)
# Kafka protocol (port 9093) is not exposed by Private Link endpoints
transport:
  type: ${PIPELINE_TRANSPORT:-eventhub}

# =============================================================================
# EVENT HUB (AMQP TRANSPORT - DEFAULT)
# =============================================================================
# Azure Event Hub using AMQP over WebSocket (port 443)
# Compatible with Azure Private Link endpoints
#
# Architecture:
#   One Event Hub NAMESPACE contains multiple Event Hubs.
#   A single namespace-level connection string (no EntityPath) provides
#   access to all Event Hubs. Each is specified separately per-topic below.
#
# Connection string format (namespace-level — NO EntityPath):
#   Endpoint=sb://<namespace>.servicebus.windows.net/;
#   SharedAccessKeyName=<policy>;SharedAccessKey=<key>
#
# Jenkins/deployment injects ONE secret: EVENTHUB_NAMESPACE_CONNECTION_STRING
# Event Hub names and consumer groups are defined below per-domain.
#
# Consumer group notes:
#   Each worker that independently reads a stream needs its own consumer group.
#   Consumer groups are keyed by worker_name under each topic:
#     eventhub.{domain}.{topic_key}.consumer_groups.{worker_name}
#   Consumer groups must be pre-created in Azure before use.
#
# Owner level (epoch) notes:
#   owner_levels is an optional sibling to consumer_groups that sets the epoch
#   for exclusive partition ownership per consumer group. A consumer with a higher
#   owner_level takes ownership from consumers with lower levels. Default: 0.
#   Example:
#     owner_levels:
#       enrichment_worker: 1
eventhub:
  # Namespace-level connection string (no EntityPath)
  # Falls back to EVENTHUB_CONNECTION_STRING for backward compatibility
  # (EntityPath is stripped automatically if present)
  namespace_connection_string: ${EVENTHUB_NAMESPACE_CONNECTION_STRING:-}

  # Transport type: AmqpOverWebsocket (required for Private Link)
  transport_type: AmqpOverWebsocket

  # Default consumer group (used when not specified per-topic)
  default_consumer_group: ${EVENTHUB_DEFAULT_CONSUMER_GROUP:-$Default}

  # Checkpoint store configuration for durable offset persistence.
  # Checkpoints enable graceful restarts and partition rebalancing across consumers.
  # Supported types:
  #   "blob" - Azure Blob Storage (production)
  #   "json" - Local filesystem JSON files (development)
  checkpoint_store:
    # Store type: "blob" or "json"
    type: ${EVENTHUB_CHECKPOINT_STORE_TYPE:-blob}
    # Blob storage settings (used when type=blob)
    blob_storage_connection_string: ${EVENTHUB_CHECKPOINT_BLOB_CONNECTION_STRING:-}
    container_name: ${EVENTHUB_CHECKPOINT_CONTAINER_NAME:-<app-name>-checkpoints}
    # JSON file storage path (used when type=json)
    storage_path: ${EVENTHUB_CHECKPOINT_JSON_PATH:-./data/eh1-checkpoints}

  # Deduplication cache store (persistent across worker restarts)
  # Complements in-memory caching by providing blob storage persistence
  dedup_store:
    # Store type: "blob" or "json"
    type: ${EVENTHUB_DEDUP_STORE_TYPE:-blob}
    # Blob storage settings (reuses same storage account as checkpoint store)
    blob_storage_connection_string: ${EVENTHUB_CHECKPOINT_BLOB_CONNECTION_STRING:-}
    # Different container in same storage account
    container_name: ${EVENTHUB_DEDUP_CONTAINER_NAME:-eventhub-dedup-cache}
    # TTL for dedup entries (seconds) - matches Verisk's in-memory cache default
    ttl_seconds: ${EVENTHUB_DEDUP_TTL_SECONDS:-86400}
    # JSON file storage path for local dev (used when type=json)
    storage_path: ${EVENTHUB_DEDUP_JSON_PATH:-./data/eventhub-dedup-cache}

  # ---------------------------------------------------------------------------
  # Source EventHubs (external namespace)
  # ---------------------------------------------------------------------------
  # Source event topics live in a separate EventHub namespace from the internal
  # pipeline topics. This section provides the connection string and topic
  # configuration for reading raw events from the source namespace.
  source:
    namespace_connection_string: ${SOURCE_EVENTHUB_NAMESPACE_CONNECTION_STRING:-}
    verisk:
      events:
        eventhub_name: ${EVENTHUB_VERISK_EVENTS_NAME:-<verisk-source-eventhub>}
        starting_position: "<ISO-8601-datetime-or-@latest>"
        consumer_groups:
          event_ingester: ${EVENTHUB_VERISK_EVENTS_CG_EVENT_INGESTER:-<app-name>-xa}
          delta_events_writer: ${EVENTHUB_VERISK_EVENTS_CG_DELTA_EVENTS_WRITER:-<app-name>-xa-delta}
        owner_levels:
          event_ingester: ${EVENTHUB_VERISK_EVENTS_OL_EVENT_INGESTER:-0}
          delta_events_writer: ${EVENTHUB_VERISK_EVENTS_OL_DELTA_EVENTS_WRITER:-0}
    claimx:
      events:
        eventhub_name: ${EVENTHUB_CLAIMX_EVENTS_NAME:-<claimx-source-eventhub>}
        starting_position: "<ISO-8601-datetime-or-@latest>"
        consumer_groups:
          event_ingester: ${EVENTHUB_CLAIMX_EVENTS_CG_EVENT_INGESTER:-<app-name>-cx}
          delta_events_writer: ${EVENTHUB_CLAIMX_EVENTS_CG_DELTA_EVENTS_WRITER:-<app-name>-cx-delta}
        owner_levels:
          event_ingester: ${EVENTHUB_CLAIMX_EVENTS_OL_EVENT_INGESTER:-0}
          delta_events_writer: ${EVENTHUB_CLAIMX_EVENTS_OL_DELTA_EVENTS_WRITER:-0}

  # ---------------------------------------------------------------------------
  # Verisk Domain (formerly XACT)
  # ---------------------------------------------------------------------------
  # Event Hub entities for Verisk/XACT event processing pipeline
  verisk:
    enrichment_pending:
      eventhub_name: ${EVENTHUB_VERISK_ENRICHMENT_PENDING_NAME:-verisk-enrichment-pending}
      starting_position: "@latest"
      consumer_groups:
        enrichment_worker: ${EVENTHUB_VERISK_ENRICHMENT_PENDING_CG_ENRICHMENT_WORKER:-verisk-enrichment-pipeline}
      owner_levels:
        enrichment_worker: ${EVENTHUB_VERISK_ENRICHMENT_PENDING_OL_ENRICHMENT_WORKER:-0}
    downloads_pending:
      eventhub_name: ${EVENTHUB_VERISK_DOWNLOADS_PENDING_NAME:-verisk-downloads-pending}
      starting_position: "@latest"
      consumer_groups:
        download_worker: ${EVENTHUB_VERISK_DOWNLOADS_PENDING_CG_DOWNLOAD_WORKER:-verisk-downloads-pipeline}
      owner_levels:
        download_worker: ${EVENTHUB_VERISK_DOWNLOADS_PENDING_OL_DOWNLOAD_WORKER:-0}
    downloads_cached:
      eventhub_name: ${EVENTHUB_VERISK_DOWNLOADS_CACHED_NAME:-verisk-downloads-cached}
      starting_position: "@latest"
      consumer_groups:
        upload_worker: ${EVENTHUB_VERISK_DOWNLOADS_CACHED_CG_UPLOAD_WORKER:-verisk-downloads-cached-pipeline}
      owner_levels:
        upload_worker: ${EVENTHUB_VERISK_DOWNLOADS_CACHED_OL_UPLOAD_WORKER:-0}
    downloads_results:
      eventhub_name: ${EVENTHUB_VERISK_DOWNLOADS_RESULTS_NAME:-verisk-downloads-results}
      starting_position: "@latest"
      consumer_groups:
        result_processor: ${EVENTHUB_VERISK_DOWNLOADS_RESULTS_CG_RESULT_PROCESSOR:-verisk-downloads-results-pipeline}
      owner_levels:
        result_processor: ${EVENTHUB_VERISK_DOWNLOADS_RESULTS_OL_RESULT_PROCESSOR:-0}
    retry:
      eventhub_name: ${EVENTHUB_VERISK_RETRY_NAME:-verisk-retry}
      starting_position: "@latest"
      consumer_groups:
        unified_retry_scheduler: ${EVENTHUB_VERISK_RETRY_CG_RETRY_SCHEDULER:-verisk-retry-pipeline}
      owner_levels:
        unified_retry_scheduler: ${EVENTHUB_VERISK_RETRY_OL_RETRY_SCHEDULER:-0}
    dlq:
      eventhub_name: ${EVENTHUB_VERISK_DLQ_NAME:-verisk-dlq}
      starting_position: "@latest"
      consumer_groups:
        dlq_handler: ${EVENTHUB_VERISK_DLQ_CG_DLQ_HANDLER:-verisk-dlq-pipeline}
      owner_levels:
        dlq_handler: ${EVENTHUB_VERISK_DLQ_OL_DLQ_HANDLER:-0}

  # ---------------------------------------------------------------------------
  # ClaimX Domain
  # ---------------------------------------------------------------------------
  # Event Hub entities for ClaimX event processing pipeline
  claimx:
    enrichment_pending:
      eventhub_name: ${EVENTHUB_CLAIMX_ENRICHMENT_PENDING_NAME:-claimx-enrichment-pending}
      starting_position: "@latest"
      consumer_groups:
        enrichment_worker: ${EVENTHUB_CLAIMX_ENRICHMENT_PENDING_CG_ENRICHMENT_WORKER:-claimx-enrichment-pipeline}
      owner_levels:
        enrichment_worker: ${EVENTHUB_CLAIMX_ENRICHMENT_PENDING_OL_ENRICHMENT_WORKER:-0}
    enriched:
      eventhub_name: ${EVENTHUB_CLAIMX_ENRICHED_NAME:-claimx-enriched}
      starting_position: "@latest"
      consumer_groups:
        entity_delta_writer: ${EVENTHUB_CLAIMX_ENRICHED_CG_ENTITY_DELTA_WRITER:-claimx-enriched-pipeline}
      owner_levels:
        entity_delta_writer: ${EVENTHUB_CLAIMX_ENRICHED_OL_ENTITY_DELTA_WRITER:-0}
    downloads_pending:
      eventhub_name: ${EVENTHUB_CLAIMX_DOWNLOADS_PENDING_NAME:-claimx-downloads-pending}
      starting_position: "@latest"
      consumer_groups:
        download_worker: ${EVENTHUB_CLAIMX_DOWNLOADS_PENDING_CG_DOWNLOAD_WORKER:-claimx-downloads-pipeline}
      owner_levels:
        download_worker: ${EVENTHUB_CLAIMX_DOWNLOADS_PENDING_OL_DOWNLOAD_WORKER:-0}
    downloads_cached:
      eventhub_name: ${EVENTHUB_CLAIMX_DOWNLOADS_CACHED_NAME:-claimx-downloads-cached}
      starting_position: "@latest"
      consumer_groups:
        upload_worker: ${EVENTHUB_CLAIMX_DOWNLOADS_CACHED_CG_UPLOAD_WORKER:-claimx-downloads-cached-pipeline}
      owner_levels:
        upload_worker: ${EVENTHUB_CLAIMX_DOWNLOADS_CACHED_OL_UPLOAD_WORKER:-0}
    downloads_results:
      eventhub_name: ${EVENTHUB_CLAIMX_DOWNLOADS_RESULTS_NAME:-claimx-downloads-results}
      starting_position: "@latest"
      consumer_groups:
        result_processor: ${EVENTHUB_CLAIMX_DOWNLOADS_RESULTS_CG_RESULT_PROCESSOR:-claimx-downloads-results-pipeline}
      owner_levels:
        result_processor: ${EVENTHUB_CLAIMX_DOWNLOADS_RESULTS_OL_RESULT_PROCESSOR:-0}
    retry:
      eventhub_name: ${EVENTHUB_CLAIMX_RETRY_NAME:-claimx-retry}
      starting_position: "@latest"
      consumer_groups:
        unified_retry_scheduler: ${EVENTHUB_CLAIMX_RETRY_CG_RETRY_SCHEDULER:-claimx-retry-pipeline}
      owner_levels:
        unified_retry_scheduler: ${EVENTHUB_CLAIMX_RETRY_OL_RETRY_SCHEDULER:-0}
    dlq:
      eventhub_name: ${EVENTHUB_CLAIMX_DLQ_NAME:-claimx-dlq}
      starting_position: "@latest"
      consumer_groups:
        dlq_handler: ${EVENTHUB_CLAIMX_DLQ_CG_DLQ_HANDLER:-claimx-dlq-pipeline}
      owner_levels:
        dlq_handler: ${EVENTHUB_CLAIMX_DLQ_OL_DLQ_HANDLER:-0}

  # ---------------------------------------------------------------------------
  # Plugins Domain
  # ---------------------------------------------------------------------------
  # Event Hub entities for plugin integrations (iTEL Cabinet, GHRN, etc.)
  plugins:
    itel_cabinet_pending:
      eventhub_name: ${EVENTHUB_ITEL_CABINET_PENDING_NAME:-<app-name>-itel-cabinet-pending}
      starting_position: "@latest"
      consumer_groups:
        itel_cabinet_tracking_worker: ${EVENTHUB_ITEL_CABINET_PENDING_CG_TRACKING_WORKER:-itel-cabinet-pending-pipeline}
      owner_levels:
        itel_cabinet_tracking_worker: ${EVENTHUB_ITEL_CABINET_PENDING_OL_TRACKING_WORKER:-0}
    itel_cabinet_completed:
      eventhub_name: ${EVENTHUB_ITEL_CABINET_COMPLETED_NAME:-<app-name>-itel-cabinet-completed}
      starting_position: "@latest"
      consumer_groups:
        itel_cabinet_api_worker: ${EVENTHUB_ITEL_CABINET_COMPLETED_CG_API_WORKER:-itel-cabinet-completed-pipeline}
      owner_levels:
        itel_cabinet_api_worker: ${EVENTHUB_ITEL_CABINET_COMPLETED_OL_API_WORKER:-0}
    itel_cabinet_success:
      eventhub_name: ${EVENTHUB_ITEL_CABINET_SUCCESS_NAME:-<app-name>-itel-cabinet-success}
      starting_position: "@latest"
    itel_cabinet_errors:
      eventhub_name: ${EVENTHUB_ITEL_CABINET_ERRORS_NAME:-<app-name>-itel-cabinet-errors}
      starting_position: "@latest"
    itel_api_success:
      eventhub_name: ${EVENTHUB_ITEL_API_SUCCESS_NAME:-<app-name>-itel-api-success}
      starting_position: "@latest"
    itel_api_errors:
      eventhub_name: ${EVENTHUB_ITEL_API_ERRORS_NAME:-<app-name>-itel-api-errors}
      starting_position: "@latest"
    ghrn_mitigation_pending:
      eventhub_name: ${EVENTHUB_GHRN_MITIGATION_PENDING_NAME:-<app-name>-ghrn-mitigation-pending}
      starting_position: "@latest"
      consumer_groups:
        mitigation_tracking_worker: ${EVENTHUB_GHRN_MITIGATION_PENDING_CG_TRACKING_WORKER:-ghrn-mitigation-pending-pipeline}
      owner_levels:
        mitigation_tracking_worker: ${EVENTHUB_GHRN_MITIGATION_PENDING_OL_TRACKING_WORKER:-0}
    ghrn_mitigation_completed:
      eventhub_name: ${EVENTHUB_GHRN_MITIGATION_COMPLETED_NAME:-<app-name>-ghrn-mitigation-completed}
      starting_position: "@latest"

# =============================================================================
# LOGGING & MONITORING
# =============================================================================
logging:
  level: ${LOG_LEVEL:-INFO}
  log_to_stdout: ${LOG_TO_STDOUT:-true}
  log_dir: "/mnt/<app-name>/logs"

  # File logging configuration
  file_logging:
    enabled: ${FILE_LOGGING_ENABLED:-true}
    level: ${FILE_LOG_LEVEL:-DEBUG}

  # EventHub logging configuration (real-time streaming to ADX)
  eventhub_logging:
    enabled: ${EVENTHUB_LOGGING_ENABLED:-true}
    level: ${EVENTHUB_LOG_LEVEL:-INFO}
    eventhub_name: ${EVENTHUB_LOGS_NAME:-<app-name>-application-logs}
    batch_size: ${EVENTHUB_LOG_BATCH_SIZE:-100}
    batch_timeout_seconds: ${EVENTHUB_LOG_BATCH_TIMEOUT:-1.0}
    max_queue_size: ${EVENTHUB_LOG_QUEUE_SIZE:-10000}
    circuit_breaker_threshold: ${EVENTHUB_LOG_CIRCUIT_THRESHOLD:-5}

observability:
  json_logs: true
  log_upload_enabled: ${LOG_UPLOAD_ENABLED:-true}
  log_max_size_mb: ${LOG_MAX_SIZE_MB:-5}
  log_rotation_minutes: ${LOG_ROTATION_MINUTES:-5}
  log_retention_hours: ${LOG_RETENTION_HOURS:-1}
  onelake_log_path: ${ONELAKE_LOG_PATH:-abfss://<workspace-id>@onelake.dfs.fabric.microsoft.com/<lakehouse-id>/Files/<app-name>}
