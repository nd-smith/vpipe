# =============================================================================
# EventHub Pipeline Configuration
# =============================================================================
# This file configures the EventHub-based event processing pipeline.
# Supports ${VAR} and ${VAR:-default} syntax for environment variable expansion.
# Secrets use env var references so they are never stored in this file.
#
# NOTE: Kafka has been removed - EventHub is used for all pipeline communication
#
# Priority chain (highest wins):
#   1. OS environment variables (Jenkins envVars in deployed environments)
#   2. .env file (local development — only sets vars not already in OS)
#   3. Values in this YAML (with ${VAR:-default} expansion)
#   4. Dataclass defaults in Python config classes
# =============================================================================

# =============================================================================
# ENVIRONMENT & PLATFORM
# =============================================================================
event_source: ${EVENT_SOURCE:-eventhouse}

# =============================================================================
# PIPELINE CONFIGURATION
# =============================================================================
pipeline:
  # ---------------------------------------------------------------------------
  # Verisk Domain (formerly XACT)
  # ---------------------------------------------------------------------------
  verisk:
    retry_delays: [300, 600, 1200, 2400]  # 5m, 10m, 20m, 40m

  # ---------------------------------------------------------------------------
  # ClaimX Domain
  # ---------------------------------------------------------------------------
  claimx:
    retry_delays: [300, 600, 1200, 2400]  # 5m, 10m, 20m, 40m

  # ---------------------------------------------------------------------------
  # Shared Storage
  # ---------------------------------------------------------------------------
  storage:
    onelake_base_path: ${ONELAKE_BASE_PATH:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Files/veriskPipeline}
    onelake_domain_paths:
      verisk: ""
      claimx: ""
    cache_dir: ${CACHE_DIR:-/tmp/pipeline_cache}

# =============================================================================
# EVENTHOUSE - VERISK DOMAIN
# =============================================================================
verisk_eventhouse:
  cluster_url: ${EVENTHOUSE_CLUSTER_URL:-https://trd-atjd28cdnn65pbxjek.z8.kusto.fabric.microsoft.com}
  database: ${XACT_EVENTHOUSE_DATABASE}
  query_timeout_seconds: 120
  poller:
    source_table: ${XACT_EVENTHOUSE_SOURCE_TABLE}
    poll_interval_seconds: 30
    batch_size: 1000
  dedup:
    verisk_events_window_hours: 24
    eventhouse_query_window_hours: 1
    overlap_minutes: 5

# =============================================================================
# EVENTHOUSE - CLAIMX DOMAIN
# =============================================================================
claimx_eventhouse:
  cluster_url: ${EVENTHOUSE_CLUSTER_URL:-https://trd-atjd28cdnn65pbxjek.z8.kusto.fabric.microsoft.com}
  database: ${CLAIMX_EVENTHOUSE_DATABASE}
  query_timeout_seconds: 120
  poller:
    source_table: ${CLAIMX_EVENTHOUSE_SOURCE_TABLE}
    poll_interval_seconds: 30
    batch_size: 1000
    events_table_path: ${CLAIMX_EVENTS_TABLE_PATH}
  dedup:
    claimx_events_window_hours: 24
    eventhouse_query_window_hours: 1
    overlap_minutes: 5

# =============================================================================
# AZURE AUTHENTICATION
# =============================================================================
# Secrets use env var references — never stored as plain text in this file.
# In deployed environments, Jenkins injects these as OS env vars.
# Locally, set them in the .env file.
azure:
  tenant_id: ${AZURE_TENANT_ID}
  client_id: ${AZURE_CLIENT_ID}
  client_secret: ${AZURE_CLIENT_SECRET}
  workspace_id: ${AZURE_WORKSPACE_ID:-7729c159-0674-42ba-abf7-a6756723c62f}
  lakehouse_id: ${AZURE_LAKEHOUSE_ID:-584315ee-2f41-4943-949f-901d438bcd36}

# =============================================================================
# DELTA LAKE TABLE PATHS
# =============================================================================
delta:
  enable_writes: true

  # XACT domain
  verisk:
    events_table_path: ${XACT_DELTA_EVENTS_TABLE}
    inventory_table_path: ${XACT_DELTA_INVENTORY_TABLE}
    failed_table_path: ""

  # ClaimX domain
  claimx:
    events_table_path: ${CLAIMX_DELTA_EVENTS_TABLE}
    inventory_table_path: ${CLAIMX_DELTA_INVENTORY_TABLE}
    failed_table_path: ""
    projects_table_path: ${CLAIMX_DELTA_PROJECTS_TABLE}
    contacts_table_path: ${CLAIMX_DELTA_CONTACTS_TABLE}
    media_table_path: ${CLAIMX_DELTA_MEDIA_TABLE}
    tasks_table_path: ${CLAIMX_DELTA_TASKS_TABLE}
    task_templates_table_path: ${CLAIMX_DELTA_TASK_TEMPLATES_TABLE}
    external_links_table_path: ${CLAIMX_DELTA_EXTERNAL_LINKS_TABLE}
    video_collab_table_path: ${CLAIMX_DELTA_VIDEO_COLLAB_TABLE}

# =============================================================================
# CLAIMX API
# =============================================================================
claimx:
  api:
    base_url: ${CLAIMX_API_BASE_PATH:-https://www.claimxperience.com/service/cxedirest}
    timeout_seconds: 30
    max_concurrent: 20
    # Token loaded from CLAIMX_API_TOKEN env var

# =============================================================================
# PLUGINS - ITEL CABINET API
# =============================================================================
itel_cabinet:
  api_base_url: ${ITEL_CABINET_API_BASE_URL}
  api_token: ${ITEL_CABINET_API_TOKEN}
  delta_forms_table: ${ITEL_DELTA_FORMS_TABLE}
  delta_attachments_table: ${ITEL_DELTA_ATTACHMENTS_TABLE}
  attachments_path: ${ITEL_ATTACHMENTS_PATH}

# =============================================================================
# TRANSPORT LAYER CONFIGURATION
# =============================================================================
# Select transport protocol: "eventhub" (default) or "kafka"
# Event Hub is required for Azure Private Link (AMQP port 443)
# Kafka protocol (port 9093) is not exposed by Private Link endpoints
transport:
  type: ${PIPELINE_TRANSPORT:-eventhub}

# =============================================================================
# EVENT HUB (AMQP TRANSPORT - DEFAULT)
# =============================================================================
# Azure Event Hub using AMQP over WebSocket (port 443)
# Compatible with Azure Private Link endpoints
#
# Architecture:
#   One Event Hub NAMESPACE contains multiple Event Hubs.
#   A single namespace-level connection string (no EntityPath) provides
#   access to all Event Hubs. Each is specified separately per-topic below.
#
# Connection string format (namespace-level — NO EntityPath):
#   Endpoint=sb://<namespace>.servicebus.windows.net/;
#   SharedAccessKeyName=<policy>;SharedAccessKey=<key>
#
# Jenkins/deployment injects ONE secret: EVENTHUB_NAMESPACE_CONNECTION_STRING
# Event Hub names and consumer groups are defined below per-domain.
#
# Consumer group notes:
#   A consumer group is per-application, NOT per-process.
#   Multiple instances of the same app share ONE consumer group to
#   balance partitions across processes (horizontal scaling).
#   Use separate consumer groups for independent readers of the same stream.
eventhub:
  # Namespace-level connection string (no EntityPath)
  # Falls back to EVENTHUB_CONNECTION_STRING for backward compatibility
  # (EntityPath is stripped automatically if present)
  namespace_connection_string: ${EVENTHUB_NAMESPACE_CONNECTION_STRING:-}

  # Transport type: AmqpOverWebsocket (required for Private Link)
  transport_type: AmqpOverWebsocket

  # Default consumer group (used when not specified per-topic)
  default_consumer_group: ${EVENTHUB_DEFAULT_CONSUMER_GROUP:-$Default}

  # Checkpoint store configuration for durable offset persistence.
  # Checkpoints enable graceful restarts and partition rebalancing across consumers.
  # Supported types:
  #   "blob" - Azure Blob Storage (production)
  #   "json" - Local filesystem JSON files (development)
  checkpoint_store:
    # Store type: "blob" or "json"
    type: ${EVENTHUB_CHECKPOINT_STORE_TYPE:-blob}
    # Blob storage settings (used when type=blob)
    blob_storage_connection_string: ${EVENTHUB_CHECKPOINT_BLOB_CONNECTION_STRING:-}
    container_name: ${EVENTHUB_CHECKPOINT_CONTAINER_NAME:-eventhub-checkpoints}
    # JSON file storage path (used when type=json)
    storage_path: ${EVENTHUB_CHECKPOINT_JSON_PATH:-./data/eventhub-checkpoints}

  # Deduplication cache store (persistent across worker restarts)
  # Complements in-memory caching by providing blob storage persistence
  dedup_store:
    # Store type: "blob" or "json"
    type: ${EVENTHUB_DEDUP_STORE_TYPE:-blob}
    # Blob storage settings (reuses same storage account as checkpoint store)
    blob_storage_connection_string: ${EVENTHUB_CHECKPOINT_BLOB_CONNECTION_STRING:-}
    # Different container in same storage account
    container_name: ${EVENTHUB_DEDUP_CONTAINER_NAME:-eventhub-dedup-cache}
    # TTL for dedup entries (seconds) - matches Verisk's in-memory cache default
    ttl_seconds: ${EVENTHUB_DEDUP_TTL_SECONDS:-86400}
    # JSON file storage path for local dev (used when type=json)
    storage_path: ${EVENTHUB_DEDUP_JSON_PATH:-./data/eventhub-dedup-cache}

  # ---------------------------------------------------------------------------
  # Verisk Domain (formerly XACT)
  # ---------------------------------------------------------------------------
  # Event Hub entities for Verisk/XACT event processing pipeline
  verisk:
    events:
      eventhub_name: ${EVENTHUB_VERISK_EVENTS_NAME:-verisk_events}
      consumer_group: ${EVENTHUB_VERISK_EVENTS_CONSUMER_GROUP:-verisk-pipeline}
    enrichment_pending:
      eventhub_name: ${EVENTHUB_VERISK_ENRICHMENT_PENDING_NAME:-verisk-enrichment-pending}
      consumer_group: ${EVENTHUB_VERISK_ENRICHMENT_PENDING_CONSUMER_GROUP:-verisk-enrichment-pipeline}
    downloads_pending:
      eventhub_name: ${EVENTHUB_VERISK_DOWNLOADS_PENDING_NAME:-verisk-downloads-pending}
      consumer_group: ${EVENTHUB_VERISK_DOWNLOADS_PENDING_CONSUMER_GROUP:-verisk-downloads-pipeline}
    downloads_cached:
      eventhub_name: ${EVENTHUB_VERISK_DOWNLOADS_CACHED_NAME:-verisk-downloads-cached}
      consumer_group: ${EVENTHUB_VERISK_DOWNLOADS_CACHED_CONSUMER_GROUP:-verisk-downloads-cached-pipeline}
    downloads_results:
      eventhub_name: ${EVENTHUB_VERISK_DOWNLOADS_RESULTS_NAME:-verisk-downloads-results}
      consumer_group: ${EVENTHUB_VERISK_DOWNLOADS_RESULTS_CONSUMER_GROUP:-verisk-downloads-results-pipeline}
    retry:
      eventhub_name: ${EVENTHUB_VERISK_RETRY_NAME:-verisk-retry}
      consumer_group: ${EVENTHUB_VERISK_RETRY_CONSUMER_GROUP:-verisk-retry-pipeline}
    dlq:
      eventhub_name: ${EVENTHUB_VERISK_DLQ_NAME:-verisk-dlq}
      consumer_group: ${EVENTHUB_VERISK_DLQ_CONSUMER_GROUP:-verisk-dlq-pipeline}

  # ---------------------------------------------------------------------------
  # ClaimX Domain
  # ---------------------------------------------------------------------------
  # Event Hub entities for ClaimX event processing pipeline
  claimx:
    events:
      eventhub_name: ${EVENTHUB_CLAIMX_EVENTS_NAME:-claimx_events}
      consumer_group: ${EVENTHUB_CLAIMX_EVENTS_CONSUMER_GROUP:-claimx-pipeline}
    enrichment_pending:
      eventhub_name: ${EVENTHUB_CLAIMX_ENRICHMENT_PENDING_NAME:-claimx-enrichment-pending}
      consumer_group: ${EVENTHUB_CLAIMX_ENRICHMENT_PENDING_CONSUMER_GROUP:-claimx-enrichment-pipeline}
    enriched:
      eventhub_name: ${EVENTHUB_CLAIMX_ENRICHED_NAME:-claimx-enriched}
      consumer_group: ${EVENTHUB_CLAIMX_ENRICHED_CONSUMER_GROUP:-claimx-enriched-pipeline}
    downloads_pending:
      eventhub_name: ${EVENTHUB_CLAIMX_DOWNLOADS_PENDING_NAME:-claimx-downloads-pending}
      consumer_group: ${EVENTHUB_CLAIMX_DOWNLOADS_PENDING_CONSUMER_GROUP:-claimx-downloads-pipeline}
    downloads_cached:
      eventhub_name: ${EVENTHUB_CLAIMX_DOWNLOADS_CACHED_NAME:-claimx-downloads-cached}
      consumer_group: ${EVENTHUB_CLAIMX_DOWNLOADS_CACHED_CONSUMER_GROUP:-claimx-downloads-cached-pipeline}
    downloads_results:
      eventhub_name: ${EVENTHUB_CLAIMX_DOWNLOADS_RESULTS_NAME:-claimx-downloads-results}
      consumer_group: ${EVENTHUB_CLAIMX_DOWNLOADS_RESULTS_CONSUMER_GROUP:-claimx-downloads-results-pipeline}
    retry:
      eventhub_name: ${EVENTHUB_CLAIMX_RETRY_NAME:-claimx-retry}
      consumer_group: ${EVENTHUB_CLAIMX_RETRY_CONSUMER_GROUP:-claimx-retry-pipeline}
    dlq:
      eventhub_name: ${EVENTHUB_CLAIMX_DLQ_NAME:-claimx-dlq}
      consumer_group: ${EVENTHUB_CLAIMX_DLQ_CONSUMER_GROUP:-claimx-dlq-pipeline}

  # ---------------------------------------------------------------------------
  # Plugins Domain
  # ---------------------------------------------------------------------------
  # Event Hub entities for plugin integrations (iTEL Cabinet, GHRN, etc.)
  plugins:
    itel_cabinet_pending:
      eventhub_name: ${EVENTHUB_ITEL_CABINET_PENDING_NAME:-pcesdopodappv1-itel-cabinet-pending}
      consumer_group: ${EVENTHUB_ITEL_CABINET_PENDING_CONSUMER_GROUP:-itel-cabinet-pending-pipeline}
    itel_cabinet_completed:
      eventhub_name: ${EVENTHUB_ITEL_CABINET_COMPLETED_NAME:-pcesdopodappv1-itel-cabinet-completed}
      consumer_group: ${EVENTHUB_ITEL_CABINET_COMPLETED_CONSUMER_GROUP:-itel-cabinet-completed-pipeline}
    itel_cabinet_success:
      eventhub_name: ${EVENTHUB_ITEL_CABINET_SUCCESS_NAME:-pcesdopodappv1-itel-cabinet-success}
      consumer_group: ${EVENTHUB_ITEL_CABINET_SUCCESS_CONSUMER_GROUP:-itel-cabinet-success-pipeline}
    itel_cabinet_errors:
      eventhub_name: ${EVENTHUB_ITEL_CABINET_ERRORS_NAME:-pcesdopodappv1-itel-cabinet-errors}
      consumer_group: ${EVENTHUB_ITEL_CABINET_ERRORS_CONSUMER_GROUP:-itel-cabinet-errors-pipeline}
    itel_api_success:
      eventhub_name: ${EVENTHUB_ITEL_API_SUCCESS_NAME:-pcesdopodappv1-itel-api-success}
      consumer_group: ${EVENTHUB_ITEL_API_SUCCESS_CONSUMER_GROUP:-itel-api-success-pipeline}
    itel_api_errors:
      eventhub_name: ${EVENTHUB_ITEL_API_ERRORS_NAME:-pcesdopodappv1-itel-api-errors}
      consumer_group: ${EVENTHUB_ITEL_API_ERRORS_CONSUMER_GROUP:-itel-api-errors-pipeline}
    ghrn_mitigation_pending:
      eventhub_name: ${EVENTHUB_GHRN_MITIGATION_PENDING_NAME:-pcesdopodappv1-ghrn-mitigation-pending}
      consumer_group: ${EVENTHUB_GHRN_MITIGATION_PENDING_CONSUMER_GROUP:-ghrn-mitigation-pending-pipeline}
    ghrn_mitigation_completed:
      eventhub_name: ${EVENTHUB_GHRN_MITIGATION_COMPLETED_NAME:-pcesdopodappv1-ghrn-mitigation-completed}
      consumer_group: ${EVENTHUB_GHRN_MITIGATION_COMPLETED_CONSUMER_GROUP:-ghrn-mitigation-completed-pipeline}

# =============================================================================
# LOGGING & MONITORING
# =============================================================================
logging:
  level: ${LOG_LEVEL:-INFO}
  log_to_stdout: ${LOG_TO_STDOUT:-true}
  log_dir: "logs"

observability:
  json_logs: true
  log_upload_enabled: ${LOG_UPLOAD_ENABLED:-true}
  log_max_size_mb: ${LOG_MAX_SIZE_MB:-5}
  log_rotation_minutes: ${LOG_ROTATION_MINUTES:-5}
  log_retention_hours: ${LOG_RETENTION_HOURS:-1}
  onelake_log_path: ${ONELAKE_LOG_PATH:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Files/veriskPipeline/logs}
