# =============================================================================
# Kafka Pipeline Configuration
# =============================================================================
# This file configures the Kafka-based event processing pipeline.
# Supports ${VAR} and ${VAR:-default} syntax for environment variable expansion.
# Secrets use env var references so they are never stored in this file.
#
# Priority chain (highest wins):
#   1. OS environment variables (Jenkins envVars in deployed environments)
#   2. .env file (local development — only sets vars not already in OS)
#   3. Values in this YAML (with ${VAR:-default} expansion)
#   4. Dataclass defaults in Python config classes
# =============================================================================

# =============================================================================
# ENVIRONMENT & PLATFORM
# =============================================================================
event_source: ${EVENT_SOURCE:-eventhouse}

# =============================================================================
# KAFKA PIPELINE CONFIGURATION
# =============================================================================
kafka:
  # ---------------------------------------------------------------------------
  # Corporate Kafka Cluster (Remote)
  # ---------------------------------------------------------------------------
  connection:
    bootstrap_servers: ${KAFKA_BOOTSTRAP_SERVERS:-lxv102325.allstate.com:9093,lxv102326.allstate.com:9093,lxv102327.allstate.com:9093,lxv102328.allstate.com:9093,lxv102329.allstate.com:9093,lxv102330.allstate.com:9093,lxv102331.allstate.com:9093,lxv102332.allstate.com:9093}
    security_protocol: ${KAFKA_SECURITY_PROTOCOL:-SASL_SSL}
    sasl_mechanism: ${KAFKA_SASL_MECHANISM:-GSSAPI}
    sasl_kerberos_service_name: ${KAFKA_SASL_KERBEROS_SERVICE_NAME:-kafka}
    schema_registry_url: ${KAFKA_SCHEMA_REGISTRY_URL:-https://rtvdevro-kafka.tptigslb.allstate.com:8081}

  consumer_defaults:
    auto_offset_reset: earliest
    enable_auto_commit: false
    max_poll_records: 100

  producer_defaults:
    acks: "1"
    compression_type: "lz4"

  # ---------------------------------------------------------------------------
  # XACT Domain
  # ---------------------------------------------------------------------------
  xact:
    topics:
      events: "com.allstate.pcesdopodappv1.xact.events.raw"
      enrichment_pending: "com.allstate.pcesdopodappv1.xact.enrichment.pending"
      downloads_pending: "com.allstate.pcesdopodappv1.xact.downloads.pending"
      downloads_cached: "com.allstate.pcesdopodappv1.xact.downloads.cached"
      downloads_results: "com.allstate.pcesdopodappv1.xact.downloads.results"
      dlq: "com.allstate.pcesdopodappv1.xact.downloads.dlq"

    consumer_group_prefix: "xact"
    retry_delays: [300, 600, 1200, 2400]  # 5m, 10m, 20m, 40m
    max_retries: 4

  # ---------------------------------------------------------------------------
  # ClaimX Domain
  # ---------------------------------------------------------------------------
  claimx:
    topics:
      events: "com.allstate.pcesdopodappv1.claimx.events.raw"
      enrichment_pending: "com.allstate.pcesdopodappv1.claimx.enrichment.pending"
      enrichment.dlq: "com.allstate.pcesdopodappv1.claimx.enrichment.dlq"
      entities_rows: "com.allstate.pcesdopodappv1.claimx.entities.rows"
      downloads_pending: "com.allstate.pcesdopodappv1.claimx.downloads.pending"
      downloads_cached: "com.allstate.pcesdopodappv1.claimx.downloads.cached"
      downloads_results: "com.allstate.pcesdopodappv1.claimx.downloads.results"
      dlq: "com.allstate.pcesdopodappv1.claimx.downloads.dlq"

    consumer_group_prefix: "claimx"
    retry_delays: [300, 600, 1200, 2400]  # 5m, 10m, 20m, 40m
    max_retries: 4

  # ---------------------------------------------------------------------------
  # Shared Storage
  # ---------------------------------------------------------------------------
  storage:
    onelake_base_path: ${ONELAKE_BASE_PATH:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Files/veriskPipeline}
    onelake_domain_paths:
      xact: ""
      claimx: ""
    cache_dir: ${CACHE_DIR:-/tmp/kafka_pipeline_cache}

# =============================================================================
# LOCAL / INTERNAL PIPELINE KAFKA
# =============================================================================
# In deployed environments, this points to the same corporate cluster.
# For local development, override via LOCAL_KAFKA_* env vars or .env file.
local_kafka:
  bootstrap_servers: ${LOCAL_KAFKA_BOOTSTRAP_SERVERS:-lxv102325.allstate.com:9093,lxv102326.allstate.com:9093,lxv102327.allstate.com:9093,lxv102328.allstate.com:9093,lxv102329.allstate.com:9093,lxv102330.allstate.com:9093,lxv102331.allstate.com:9093,lxv102332.allstate.com:9093}
  security_protocol: ${LOCAL_KAFKA_SECURITY_PROTOCOL:-SASL_SSL}
  sasl_mechanism: ${LOCAL_KAFKA_SASL_MECHANISM:-GSSAPI}
  consumer_poll_timeout_ms: 1000
  producer_max_block_ms: 60000

# =============================================================================
# EVENTHOUSE - XACT DOMAIN
# =============================================================================
eventhouse:
  cluster_url: ${EVENTHOUSE_CLUSTER_URL:-https://trd-atjd28cdnn65pbxjek.z8.kusto.fabric.microsoft.com}
  database: ${XACT_EVENTHOUSE_DATABASE:-VERISK_XACTANALYSIS_DB}
  query_timeout_seconds: 120
  poller:
    source_table: ${XACT_EVENTHOUSE_SOURCE_TABLE:-tbl_VERISK_XACTANALYSIS_STATUS_EXPORT}
    poll_interval_seconds: 30
    batch_size: 1000
  dedup:
    xact_events_window_hours: 24
    eventhouse_query_window_hours: 1
    overlap_minutes: 5

# =============================================================================
# EVENTHOUSE - CLAIMX DOMAIN
# =============================================================================
claimx_eventhouse:
  cluster_url: ${EVENTHOUSE_CLUSTER_URL:-https://trd-atjd28cdnn65pbxjek.z8.kusto.fabric.microsoft.com}
  database: ${CLAIMX_EVENTHOUSE_DATABASE:-VERISK_CLAIMXPERIENCE_DB}
  query_timeout_seconds: 120
  poller:
    source_table: ${CLAIMX_EVENTHOUSE_SOURCE_TABLE:-tbl_CLAIMXPERIENCE_EVENTS}
    poll_interval_seconds: 30
    batch_size: 1000
  dedup:
    claimx_events_window_hours: 24
    eventhouse_query_window_hours: 1
    overlap_minutes: 5

# =============================================================================
# AZURE AUTHENTICATION
# =============================================================================
# Secrets use env var references — never stored as plain text in this file.
# In deployed environments, Jenkins injects these as OS env vars.
# Locally, set them in the .env file.
azure:
  tenant_id: ${AZURE_TENANT_ID}
  client_id: ${AZURE_CLIENT_ID}
  client_secret: ${AZURE_CLIENT_SECRET}
  workspace_id: ${AZURE_WORKSPACE_ID:-7729c159-0674-42ba-abf7-a6756723c62f}
  lakehouse_id: ${AZURE_LAKEHOUSE_ID:-584315ee-2f41-4943-949f-901d438bcd36}

# =============================================================================
# DELTA LAKE TABLE PATHS
# =============================================================================
delta:
  enable_writes: true

  # XACT domain
  xact:
    events_table_path: ${XACT_DELTA_EVENTS_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/xact_events}
    inventory_table_path: ${XACT_DELTA_INVENTORY_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/xact_attachments}
    failed_table_path: ""

  # ClaimX domain
  claimx:
    events_table_path: ${CLAIMX_DELTA_EVENTS_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/claimx_events}
    inventory_table_path: ${CLAIMX_DELTA_INVENTORY_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/claimx_attachments}
    failed_table_path: ""
    projects_table_path: ${CLAIMX_DELTA_PROJECTS_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/claimx_projects}
    contacts_table_path: ${CLAIMX_DELTA_CONTACTS_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/claimx_contacts}
    media_table_path: ${CLAIMX_DELTA_MEDIA_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/claimx_attachments_metadata}
    tasks_table_path: ${CLAIMX_DELTA_TASKS_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/claimx_tasks}
    task_templates_table_path: ${CLAIMX_DELTA_TASK_TEMPLATES_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/claimx_task_templates}
    external_links_table_path: ${CLAIMX_DELTA_EXTERNAL_LINKS_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/claimx_external_link}
    video_collab_table_path: ${CLAIMX_DELTA_VIDEO_COLLAB_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/claimx_video_collab}

# =============================================================================
# CLAIMX API
# =============================================================================
claimx:
  api:
    base_url: ${CLAIMX_API_BASE_PATH:-https://www.claimxperience.com/service/cxedirest}
    timeout_seconds: 30
    max_concurrent: 20
    # Token loaded from CLAIMX_API_TOKEN env var

# =============================================================================
# PLUGINS - ITEL CABINET API
# =============================================================================
itel_cabinet:
  api_base_url: ${ITEL_CABINET_API_BASE_URL}
  api_token: ${ITEL_CABINET_API_TOKEN}
  delta_forms_table: ${ITEL_DELTA_FORMS_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/claimx_itel_forms}
  delta_attachments_table: ${ITEL_DELTA_ATTACHMENTS_TABLE:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Tables/dbo/claimx_itel_attachments}
  attachments_path: ${ITEL_ATTACHMENTS_PATH:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Files/veriskPipeline/itel_cabinet_form/attachments}

# =============================================================================
# TRANSPORT LAYER CONFIGURATION
# =============================================================================
# Select transport protocol: "eventhub" (default) or "kafka"
# Event Hub is required for Azure Private Link (AMQP port 443)
# Kafka protocol (port 9093) is not exposed by Private Link endpoints
transport:
  type: ${PIPELINE_TRANSPORT:-eventhub}

# =============================================================================
# EVENT HUB (AMQP TRANSPORT - DEFAULT)
# =============================================================================
# Azure Event Hub using AMQP over WebSocket (port 443)
# Compatible with Azure Private Link endpoints
#
# Architecture:
#   One Event Hub NAMESPACE contains multiple Event Hubs.
#   A single namespace-level connection string (no EntityPath) provides
#   access to all Event Hubs. Each is specified separately per-topic below.
#
# Connection string format (namespace-level — NO EntityPath):
#   Endpoint=sb://<namespace>.servicebus.windows.net/;
#   SharedAccessKeyName=<policy>;SharedAccessKey=<key>
#
# Jenkins/deployment injects ONE secret: EVENTHUB_NAMESPACE_CONNECTION_STRING
# Event Hub names and consumer groups are defined below per-domain.
#
# Consumer group notes:
#   A consumer group is per-application, NOT per-process.
#   Multiple instances of the same app share ONE consumer group to
#   balance partitions across processes (horizontal scaling).
#   Use separate consumer groups for independent readers of the same stream.
eventhub:
  # Namespace-level connection string (no EntityPath)
  # Falls back to EVENTHUB_CONNECTION_STRING for backward compatibility
  # (EntityPath is stripped automatically if present)
  namespace_connection_string: ${EVENTHUB_NAMESPACE_CONNECTION_STRING:-}

  # Transport type: AmqpOverWebsocket (required for Private Link)
  transport_type: AmqpOverWebsocket

  # Default consumer group (used when not specified per-topic)
  default_consumer_group: ${EVENTHUB_DEFAULT_CONSUMER_GROUP:-$Default}

  # Checkpoint store configuration for durable offset persistence.
  # Azure Blob Storage is used to store consumer checkpoints, enabling
  # graceful restarts and partition rebalancing across multiple consumers.
  checkpoint_store:
    blob_storage_connection_string: ${EVENTHUB_CHECKPOINT_BLOB_CONNECTION_STRING:-}
    container_name: ${EVENTHUB_CHECKPOINT_CONTAINER_NAME:-eventhub-checkpoints}

  # ---------------------------------------------------------------------------
  # XACT Domain
  # ---------------------------------------------------------------------------
  # Currently Event Hub is only used as the external event source.
  # Internal pipeline routing (downloads, enrichment, DLQ) uses local Kafka.
  # Add more entries here if/when those stages migrate to Event Hub.
  xact:
    events:
      eventhub_name: ${EVENTHUB_XACT_EVENTS_NAME:-verisk_events}
      consumer_group: ${EVENTHUB_XACT_EVENTS_CONSUMER_GROUP:-xact-pipeline}
    dlq:
      eventhub_name: ${EVENTHUB_XACT_DLQ_NAME:-xact-dlq}
      consumer_group: ${EVENTHUB_XACT_DLQ_CONSUMER_GROUP:-xact-dlq-pipeline}

  # ---------------------------------------------------------------------------
  # ClaimX Domain
  # ---------------------------------------------------------------------------
  claimx:
    events:
      eventhub_name: ${EVENTHUB_CLAIMX_EVENTS_NAME:-claimx_events}
      consumer_group: ${EVENTHUB_CLAIMX_EVENTS_CONSUMER_GROUP:-claimx-pipeline}
    dlq:
      eventhub_name: ${EVENTHUB_CLAIMX_DLQ_NAME:-claimx-dlq}
      consumer_group: ${EVENTHUB_CLAIMX_DLQ_CONSUMER_GROUP:-claimx-dlq-pipeline}

# =============================================================================
# LOGGING & MONITORING
# =============================================================================
logging:
  level: ${LOG_LEVEL:-INFO}
  log_to_stdout: ${LOG_TO_STDOUT:-true}
  log_dir: "logs"

observability:
  json_logs: true
  log_upload_enabled: ${LOG_UPLOAD_ENABLED:-true}
  log_max_size_mb: ${LOG_MAX_SIZE_MB:-5}
  log_rotation_minutes: ${LOG_ROTATION_MINUTES:-5}
  log_retention_hours: ${LOG_RETENTION_HOURS:-1}
  onelake_log_path: ${ONELAKE_LOG_PATH:-abfss://7729c159-0674-42ba-abf7-a6756723c62f@onelake.dfs.fabric.microsoft.com/584315ee-2f41-4943-949f-901d438bcd36/Files/veriskPipeline/logs}
