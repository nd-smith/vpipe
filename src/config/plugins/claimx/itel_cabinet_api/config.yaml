# =============================================================================
# iTel Cabinet Task Tracking Plugin Configuration
# =============================================================================
# Tracks the complete lifecycle of iTel Cabinet Repair Form tasks (task_id 27019, 1234)
# from creation through completion. All status changes are captured and published
# to a Kafka topic for asynchronous processing and enrichment.
#
# Architecture:
#   ClaimX Event → Plugin (filter task_id=27019|1234) → Event Hub Topic → Worker → Delta Table
#
# Related Files:
#   - plugins/config/connections.yaml - ClaimX API connection config
#   - plugins/config/workers.yaml - Worker configuration
#   - SPEC.md - Technical specification
#   - README.md - User documentation
# =============================================================================

# Plugin metadata
name: itel_cabinet_api
module: pipeline.plugins.shared.task_trigger
class: TaskTriggerPlugin
enabled: true
priority: 50

# Plugin configuration
config:
  # Include full task and project data in the payload
  # This gives the worker complete context for enrichment
  include_task_data: true
  include_project_data: true

  # Task trigger configuration
  # Map of task_id (ClaimX task template ID) to trigger actions
  triggers:
    # ==========================================================================
    # iTel Cabinet Repair Form Task (Task Template ID: 27019)
    # ==========================================================================
    # This trigger captures ALL status changes for task 27019, including:
    #   - Task creation/assignment
    #   - Status transitions (assigned → in_progress → completed)
    #   - Task completion
    #   - Any other status updates
    #
    # Why on_any?
    #   We need complete lifecycle tracking, so we capture every status change
    #   rather than just specific events like assignment or completion.
    # ==========================================================================
    27019:
      name: iTel Cabinet Repair Form Task
      description: Track complete lifecycle of iTel cabinet repair tasks for operational visibility and analysis

      # Trigger on ANY status change (creation, assignment, progress, completion, etc.)
      on_any:
        # Publish to unified tracking topic
        # Worker will consume from this topic, enrich with ClaimX API data,
        # and write to Delta table for historical analysis
        publish_to_topic: pcesdopodappv1-itel-cabinet-pending

        log:
          level: info
          message: "iTel Cabinet task event tracked | event_id={event_id} | task_id={task_id} | assignment_id={assignment_id} | status={task_status}"

    1234:
      name: iTel Cabinet Repair Form Task
      description: Track complete lifecycle of iTel cabinet repair tasks for operational visibility and analysis

      on_any:
        publish_to_topic: pcesdopodappv1-itel-cabinet-pending

        log:
          level: info
          message: "iTel Cabinet task event tracked | event_id={event_id} | task_id={task_id} | assignment_id={assignment_id} | status={task_status}"

# =============================================================================
# Configuration Notes
# =============================================================================
#
# Task ID:
#   - 27019 and 1234 are ClaimX task template IDs for iTel Cabinet Repair Forms
#
# Event Tracking:
#   - on_any: Captures ALL events (CUSTOM_TASK_ASSIGNED, CUSTOM_TASK_COMPLETED, etc.)
#   - Alternative: Use on_assigned and on_completed for specific events only
#
# Event Hub Topic:
#   - pcesdopodappv1-itel-cabinet-pending: Single topic for all task 27019 events
#   - Worker consumes from this topic for processing
#   - Retention: 7 days (configured in Event Hub)
#
# Payload Structure:
#   Published messages include:
#   {
#     "trigger_name": "iTel Cabinet Repair Form Task",
#     "event_id": "unique-event-id",
#     "event_type": "CUSTOM_TASK_ASSIGNED|CUSTOM_TASK_COMPLETED|etc",
#     "project_id": "12345",
#     "task_id": 27019,
#     "assignment_id": 789,
#     "task_name": "iTel Cabinet Repair Form",
#     "task_status": "assigned|in_progress|completed|etc",
#     "timestamp": "2026-01-10T12:34:56.789Z",
#     "task": { /* full task row data */ },
#     "project": { /* full project row data */ }
#   }
#
# Monitoring:
#   - Check plugin logs: tail -f logs/claimx/enrichment_worker.log | grep "iTel Cabinet"
#   - Monitor Event Hub topic: pcesdopodappv1-itel-cabinet-pending
#   - View metrics: itel_plugin_events_triggered_total
#
# Testing:
#   1. Set enabled: true
#   2. Start enrichment worker
#   3. Create/update task 27019 in ClaimX
#   4. Verify events published to pcesdopodappv1-itel-cabinet-pending topic
#   5. Check logs for "iTel Cabinet task event tracked" messages
#
# Troubleshooting:
#   - No events triggered: Verify task_id in ClaimX matches 27019 or 1234
#   - Plugin not running: Check enrichment worker is running with plugins enabled
#   - No Event Hub messages: Check Event Hub connectivity and topic creation
#
# =============================================================================
