# =============================================================================
# Plugin Connection Definitions
# =============================================================================
# Define named HTTP connections for use in plugin workers and webhook actions.
# Each connection includes authentication, retry policies, and endpoint configuration.
#
# Usage:
#   - Plugin webhook actions: Reference by name with 'connection' param
#   - Workers: Reference by name in enrichment handlers (lookup, etc.)
#   - ActionExecutor: Automatically uses connections when provided
#
# Environment Variables:
#   - Use ${VAR_NAME} syntax to reference environment variables
#   - Store secrets in env vars, never commit them to this file
# =============================================================================

connections:
  # ===========================================================================
  # ClaimX API Connection
  # ===========================================================================
  # Used by iTel Cabinet tracking worker to fetch full task details for enrichment.
  #
  # Required Environment Variables:
  #   - CLAIMX_API_BASE_URL: ClaimX API base URL (e.g., https://api.claimx.com)
  #   - CLAIMX_API_TOKEN: Bearer token for ClaimX API authentication
  #
  # Endpoints Used:
  #   - GET /api/v1/tasks/{task_id} - Fetch complete task details
  #   - GET /api/v1/projects/{project_id} - (Optional) Fetch project details
  #
  # Usage Example:
  #   In workers.yaml enrichment pipeline:
  #   - type: lookup
  #     config:
  #       connection: claimx_api
  #       endpoint: /api/v1/tasks/{task_id}
  # ===========================================================================
  claimx_api:
    name: claimx_api
    base_url: ${CLAIMX_API_BASE_URL}  # e.g., https://api.claimx.com
    auth_type: bearer
    auth_token: ${CLAIMX_API_TOKEN}
    timeout_seconds: 30
    max_retries: 3
    retry_backoff_base: 2           # Exponential backoff: 2^n seconds
    retry_backoff_max: 60            # Max 60 seconds between retries
    headers:
      User-Agent: ClaimXPipeline-iTel/1.0
      Accept: application/json

  # ===========================================================================
  # Future: iTel Cabinet API Connection (Not Yet Implemented)
  # ===========================================================================
  # This connection will be used when we implement direct iTel Cabinet API integration.
  # Currently, the worker writes to Delta table only.
  #
  # Uncomment and configure when ready to send data to iTel:
  # ===========================================================================
  # itel_cabinet_api:
  #   name: itel_cabinet_api
  #   base_url: ${ITEL_CABINET_API_BASE_URL}  # e.g., https://api.itelcabinet.com
  #   auth_type: bearer  # or api_key, basic, depending on iTel's auth
  #   auth_token: ${ITEL_CABINET_API_TOKEN}
  #   timeout_seconds: 45
  #   max_retries: 3
  #   retry_backoff_base: 2
  #   retry_backoff_max: 90
  #   headers:
  #     User-Agent: ClaimXPipeline-iTel/1.0
  #     Accept: application/json
  #     X-Source: claimx-pipeline

# =============================================================================
# Configuration Notes
# =============================================================================
#
# Environment Variable Setup:
#   Before starting workers, export required variables:
#
#   export CLAIMX_API_BASE_URL="https://api.claimx.com"
#   export CLAIMX_API_TOKEN="your-bearer-token-here"
#
# Testing Connection:
#   Use ConnectionManager to test connections:
#
#   from kafka_pipeline.plugins.connections import ConnectionManager, ConnectionConfig
#   manager = ConnectionManager()
#   # Load connections from this file
#   await manager.start()
#   response = await manager.request("claimx_api", "GET", "/api/v1/health")
#
# Connection Pooling:
#   - Connections are pooled and reused across requests
#   - Default pool: 100 total connections, 50 per host
#   - Adjust in ConnectionManager init if needed
#
# Authentication Types:
#   - bearer: Authorization: Bearer <token>
#   - api_key: X-API-Key: <token> (or custom header via auth_header)
#   - basic: Authorization: Basic <base64(user:pass)>
#   - none: No authentication
#
# Retry Strategy:
#   - Retries on 5xx errors and connection errors
#   - Exponential backoff: wait = min(retry_backoff_base^attempt, retry_backoff_max)
#   - Example: attempt 1 = 2s, attempt 2 = 4s, attempt 3 = 8s, etc.
#
# Security Best Practices:
#   1. Never commit API tokens to version control
#   2. Use environment variables for all secrets
#   3. Rotate tokens regularly
#   4. Use HTTPS only (base_url should always start with https://)
#   5. Limit token permissions to minimum required (read-only for ClaimX API)
#
# Troubleshooting:
#   - "Connection 'xyz' not found": Check connection name spelling
#   - "Environment variable not set": Ensure ${VAR} is exported before starting
#   - "401 Unauthorized": Check auth_token is valid and not expired
#   - "Timeout": Increase timeout_seconds or check API health
#   - "Max retries exceeded": Check API is reachable and responding
#
# =============================================================================
