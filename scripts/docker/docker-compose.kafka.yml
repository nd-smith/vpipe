# docker-compose -f docker-compose.kafka.yml down -v (recreate containers - destroy volumes)
# docker-compose -f docker-compose.kafka.yml --profile ui up -d (to start with UI)
# Local Kafka for development and testing
services:
  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka-pipeline-local
    ports:
      - "9092:9092"
      - "9094:9094"
    environment:
      # KRaft mode (no Zookeeper)
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

      # Listeners Configuration
      # INTERNAL (9092): For UI and other containers
      # EXTERNAL (9094): For your host machine (IDE/Local Apps)
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      # Topic settings
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 8
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

      # Performance tuning for local dev
      KAFKA_LOG_RETENTION_HOURS: 24
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_MESSAGE_MAX_BYTES: 10485760
      KAFKA_REPLICA_FETCH_MAX_BYTES: 10485760
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  kafka-init:
    image: apache/kafka:3.7.0
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Creating Kafka topics..."
        # Using 'kafka:9092' because it is inside the docker network
        # All topics prefixed with com.allstate.pcesdopodappv1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.xact.downloads.pending --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.xact.downloads.cached --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.xact.downloads.results --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.xact.downloads.dlq --partitions 5 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.xact.events.raw --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.xact.enrichment.pending --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.xact.retry --partitions 5 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.delta-events.dlq --partitions 5 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.claimx.events.raw --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.claimx.enrichment.pending --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.claimx.downloads.pending --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.claimx.downloads.cached --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.claimx.downloads.results --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.claimx.downloads.dlq --partitions 5 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.claimx.retry --partitions 5 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.claimx.entities.rows --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.claimx.entities.rows.dlq --partitions 5 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.itel.cabinet.task.tracking --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.itel.cabinet.task.tracking.success --partitions 5 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.itel.cabinet.task.tracking.errors --partitions 5 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.itel.cabinet.api.success --partitions 5 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.itel.cabinet.api.errors --partitions 5 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.itel.cabinet.completed --partitions 5 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.claimx.mitigation.task.tracking --partitions 8 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --create --if-not-exists --bootstrap-server kafka:9092 --topic com.allstate.pcesdopodappv1.claimx.mitigation.task.success --partitions 5 --replication-factor 1

        echo "Topics created successfully:"
        /opt/kafka/bin/kafka-topics.sh --list --bootstrap-server kafka:9092

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8080:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
    profiles:
      - ui 

volumes:
  kafka_data:

networks:
  default:
    name: pipeline_network