# Simulation Mode Docker Compose
#
# This runs the complete VPipe simulation environment for local testing:
# - Kafka infrastructure (local)
# - Dummy data producer (generates 1000 events/min for both domains)
# - Dummy file server (serves test attachments)
# - All pipeline workers in simulation mode
# - Observability stack (Prometheus, Grafana)
#
# Configuration:
#   Failure injection and other simulation settings are configured in .env.simulation
#   Copy .env.simulation.example to .env.simulation and customize as needed.
#
# Usage:
#   # Start everything (including observability)
#   docker-compose -f docker-compose.simulation.yml --profile simulation up -d
#
#   # Start with observability stack (optional)
#   docker-compose -f docker-compose.simulation.yml --profile simulation --profile observability up -d
#
#   # View logs
#   docker-compose -f docker-compose.simulation.yml logs -f
#
#   # Stop everything
#   docker-compose -f docker-compose.simulation.yml down
#
# Observability URLs:
#   - Kafka UI: http://localhost:8080
#   - Prometheus: http://localhost:9090
#   - Grafana: http://localhost:3000 (admin/admin)

services:
  # =============================================================================
  # KAFKA INFRASTRUCTURE
  # =============================================================================

  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka-simulation
    ports:
      - "9092:9092"
      - "9094:9094"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

      # Listeners Configuration
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      # Topic settings
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 8
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

      # Performance tuning for simulation
      KAFKA_LOG_RETENTION_HOURS: 2
      KAFKA_LOG_SEGMENT_BYTES: 536870912  # 512MB
      KAFKA_MESSAGE_MAX_BYTES: 10485760   # 10MB
      KAFKA_REPLICA_FETCH_MAX_BYTES: 10485760
    volumes:
      - kafka_simulation_data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui-simulation
    ports:
      - "8080:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=simulation
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M

  # =============================================================================
  # SIMULATION DATA GENERATION
  # =============================================================================

  file-server:
    build:
      context: .
      dockerfile: Dockerfile
    image: kafka-pipeline:latest
    container_name: file-server-simulation
    entrypoint: ["python", "-m", "kafka_pipeline.common.dummy.file_server"]
    profiles:
      - simulation
    ports:
      - "8765:8765"
    env_file:
      - .env.simulation
    environment:
      - SIMULATION_MODE=true
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  dummy-producer:
    image: kafka-pipeline:latest
    container_name: dummy-producer-simulation
    entrypoint: ["python", "-m", "kafka_pipeline.simulation.dummy_producer"]
    command:
      - "--domains"
      - "claimx,xact"
      - "--events-per-minute"
      - "1000"
      - "--max-events"
      - "100000"
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
      file-server:
        condition: service_started
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - SKIP_EMBEDDED_FILE_SERVER=true
      - EXTERNAL_FILE_SERVER_URL=http://file-server-simulation:8765
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # =============================================================================
  # XACT SIMULATION WORKERS
  # =============================================================================

  xact-local-ingester:
    image: kafka-pipeline:latest
    container_name: xact-local-ingester-sim
    command: ["--worker", "xact-local-ingester"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  xact-enricher:
    image: kafka-pipeline:latest
    container_name: xact-enricher-sim
    command: ["--worker", "xact-enricher"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
      - /tmp/vpipe_simulation:/tmp/vpipe_simulation
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  xact-download:
    image: kafka-pipeline:latest
    command: ["--worker", "xact-download"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
      file-server:
        condition: service_started
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
      - /tmp/vpipe_simulation:/tmp/vpipe_simulation
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  xact-upload:
    image: kafka-pipeline:latest
    command: ["--worker", "xact-upload"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
      - /tmp/vpipe_simulation:/tmp/vpipe_simulation
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  xact-delta-writer:
    image: kafka-pipeline:latest
    command: ["--worker", "xact-delta-writer"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
      - DELTA_EVENTS_TABLE_PATH=/tmp/vpipe_simulation/delta/xact_events
    volumes:
      - ./logs:/app/logs
      - /tmp/vpipe_simulation:/tmp/vpipe_simulation
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  xact-retry-scheduler:
    image: kafka-pipeline:latest
    container_name: xact-retry-scheduler-sim
    command: ["--worker", "xact-retry-scheduler"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # =============================================================================
  # CLAIMX SIMULATION WORKERS
  # =============================================================================

  claimx-ingester:
    image: kafka-pipeline:latest
    container_name: claimx-ingester-sim
    command: ["--worker", "claimx-ingester"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  claimx-enricher:
    image: kafka-pipeline:latest
    command: ["--worker", "claimx-enricher"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
    env_file:
      - .env.simulation
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
      - /tmp/vpipe_simulation:/tmp/vpipe_simulation
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  claimx-downloader:
    image: kafka-pipeline:latest
    command: ["--worker", "claimx-downloader"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
      file-server:
        condition: service_started
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
      - /tmp/vpipe_simulation:/tmp/vpipe_simulation
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 256M

  claimx-uploader:
    image: kafka-pipeline:latest
    command: ["--worker", "claimx-uploader"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
      - /tmp/vpipe_simulation:/tmp/vpipe_simulation
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 256M

  claimx-delta-writer:
    image: kafka-pipeline:latest
    command: ["--worker", "claimx-delta-writer"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
      - CLAIMX_EVENTS_TABLE_PATH=/tmp/vpipe_simulation/delta/claimx_events
    volumes:
      - ./logs:/app/logs
      - /tmp/vpipe_simulation:/tmp/vpipe_simulation
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  claimx-retry-scheduler:
    image: kafka-pipeline:latest
    container_name: claimx-retry-scheduler-sim
    command: ["--worker", "claimx-retry-scheduler"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  claimx-entity-writer:
    image: kafka-pipeline:latest
    command: ["--worker", "claimx-entity-writer"]
    profiles:
      - simulation
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - SIMULATION_MODE=true
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_SECURITY_PROTOCOL=PLAINTEXT
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs
      - /tmp/vpipe_simulation:/tmp/vpipe_simulation
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  # =============================================================================
  # OBSERVABILITY STACK
  # =============================================================================

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus-simulation
    profiles:
      - simulation
      - observability
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  grafana:
    image: grafana/grafana:latest
    container_name: grafana-simulation
    profiles:
      - simulation
      - observability
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=redis-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./observability/grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./observability/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    depends_on:
      - prometheus
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M


volumes:
  kafka_simulation_data:
  prometheus_data:
  grafana_data:

networks:
  default:
    name: vpipe_simulation_network
